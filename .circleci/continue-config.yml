# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
parameters:
  base:
    type: boolean
    default: false
  infra:
    type: boolean
    default: false
  sf_maths:
    type: boolean
    default: false
  sf_ml:
    type: boolean
    default: false
  sf_preprocessing:
    type: boolean
    default: false
  sf_stats:
    type: boolean
    default: false
  sf_utils:
    type: boolean
    default: false
  sf_component:
    type: boolean
    default: false
  sf_any:
    type: boolean
    default: false
  test_ml:
    type: boolean
    default: false
  test_preprocessing:
    type: boolean
    default: false
  test_stats:
    type: boolean
    default: false
  test_infra:
    type: boolean
    default: false
  test_component:
    type: boolean
    default: false
  test_any:
    type: boolean
    default: false

jobs:
  linux_build:
    docker:
      - image: secretflow/ubuntu-base-ci:latest
    parameters:
      resource_class:
        type: string
    resource_class: << parameters.resource_class >>
    shell: /bin/bash --login -eo pipefail
    steps:
      - checkout
      - when:
          condition:
              << pipeline.parameters.base >>
          steps:
            - restore_cache:
                name: restore pip cache
                key: &pip-cache pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - run:
                name: build shared library
                command: |
                  conda init
                  arch=$(uname -i)
                  mkdir -p artifacts
                  bazel build //secretflow_lib/binding/... -c opt
                  mv bazel-bin/secretflow_lib/binding/_lib.so artifacts/_lib_$arch.so
            - run:
                name: Install python deps
                command: |
                  conda init
                  arch=$(uname -i)
                  mkdir -p artifacts
                  sed -i "s/tensorflow==/tensorflow-cpu==/g" requirements.txt
                  pip install -r requirements.txt --extra-index-url https://download.pytorch.org/whl/cpu
                  git checkout requirements.txt
            - persist_to_workspace:
                root: /root/project/
                paths: 
                  - artifacts
            - save_cache:
                key: *pip-cache
                paths:
                  - /root/miniconda3/lib/python3.10/site-packages
  macos_build:
    macos:
      xcode: 15.1
    resource_class: macos.m1.medium.gen1
    steps:
      - checkout
      - when:
          condition: 
              << pipeline.parameters.base >>
          steps:
            - run:
                name: "Install homebrew dependencies"
                command: |
                  brew install bazelisk cmake ninja libomp wget
            - run:
                name: "Install Miniconda"
                command: |
                  wget https://repo.anaconda.com/miniconda/Miniconda3-py310_24.1.2-0-MacOSX-arm64.sh -O ~/miniconda.sh
                  bash ~/miniconda.sh -b -p $HOME/miniconda
                  source $HOME/miniconda/bin/activate
                  conda init zsh
                  pip install -r requirements.txt
                  pip install -r dev-requirements.txt
            - run:
                name: "build shared library"
                command: |
                  mkdir -p artifacts
                  bazel build //secretflow_lib/binding/... -c opt
                  mv bazel-bin/secretflow_lib/binding/_lib.so artifacts/_lib_mac.so
                  pip install -r requirements.txt
                  pip install -r dev-requirements.txt
            - persist_to_workspace:
                root: .
                paths:
                  - artifacts
            - persist_to_workspace:
                root: $HOME/miniconda/lib/python3.10/
                paths: site-packages
  linux_ml_test:
    docker:
      - image: secretflow/ubuntu-base-ci:latest
    parameters:
      resource_class:
        type: string
    resource_class: << parameters.resource_class >>
    shell: /bin/bash --login -eo pipefail
    steps:
      - checkout
      - when:
          condition:
            or:
                - << pipeline.parameters.base >>
                - << pipeline.parameters.infra >>
                - << pipeline.parameters.sf_maths >>
                - << pipeline.parameters.sf_ml >>
                - << pipeline.parameters.sf_utils >>
                - << pipeline.parameters.test_ml >>
          steps:
            - restore_cache:
                name: Restore pytest testmondata
                key: testmondata-ml_{{ arch }}-{{ .Branch }}-
            - restore_cache:
                name: restore pip cache
                key: pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - attach_workspace:
                at: /root/project/
            - run:
                name: "Run tests"
                command: |
                  conda init
                  arch=$(uname -i)
                  cp artifacts/_lib_$arch.so  secretflow/security/privacy/
                  mv secretflow/security/privacy/_lib_$arch.so secretflow/security/privacy/_lib.so
                  pip install -r dev-requirements.txt
                  pytest --testmon --env prod  -n auto --junitxml=results.xml -v -x --capture=no --cov=secretflow/  --cov-report=xml:coverage.xml  --ignore=tests/ml/nn/ tests/ml/
            - save_cache:
                key: testmondata-ml_{{ arch }}-{{ .Branch }}-{{ .Revision }}
                paths:
                  - .testmondata
                when: always
            - store_test_results:
                path: ./results.xml
  linux_preprocessing_test:
    docker:
      - image: secretflow/ubuntu-base-ci:latest
    parameters:
      resource_class:
        type: string
    resource_class: << parameters.resource_class >>
    shell: /bin/bash --login -eo pipefail
    steps:
      - checkout
      - when:
          condition:
            or:
                - << pipeline.parameters.base >>
                - << pipeline.parameters.infra >>
                - << pipeline.parameters.sf_maths >>
                - << pipeline.parameters.sf_preprocessing >>
                - << pipeline.parameters.sf_utils >>
                - << pipeline.parameters.test_preprocessing >>
          steps:
            - restore_cache:
                name: Restore pytest testmondata
                key: testmondata-preprocessing_{{ arch }}-{{ .Branch }}-
            - restore_cache:
                name: restore pip cache
                key: pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - attach_workspace:
                at: /root/project/
            - run:
                name: "Run tests"
                command: |
                  conda init
                  arch=$(uname -i)
                  cp artifacts/_lib_$arch.so  secretflow/security/privacy/
                  mv secretflow/security/privacy/_lib_$arch.so secretflow/security/privacy/_lib.so
                  pip install -r dev-requirements.txt
                  pytest --testmon --env prod  -n auto --junitxml=results.xml -v -x --capture=no --cov=secretflow/  --cov-report=xml:coverage.xml  tests/preprocessing/
            - save_cache:
                key: testmondata-preprocessing_{{ arch }}-{{ .Branch }}-{{ .Revision }}
                paths:
                  - .testmondata
                when: always
            - store_test_results:
                path: ./results.xml
  linux_stats_test:
    docker:
      - image: secretflow/ubuntu-base-ci:latest
    parameters:
      resource_class:
        type: string
    resource_class: << parameters.resource_class >>
    shell: /bin/bash --login -eo pipefail
    steps:
      - checkout
      - when:
          condition:
            or:
                - << pipeline.parameters.base >>
                - << pipeline.parameters.infra >>
                - << pipeline.parameters.sf_maths >>
                - << pipeline.parameters.sf_stats >>
                - << pipeline.parameters.sf_utils >>
                - << pipeline.parameters.test_stats >>
          steps:
            - restore_cache:
                name: Restore pytest testmondata
                key: testmondata-stats_{{ arch }}-{{ .Branch }}-
            - restore_cache:
                name: restore pip cache
                key: pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - attach_workspace:
                at: /root/project/
            - run:
                name: "Run tests"
                command: |
                  conda init
                  arch=$(uname -i)
                  cp artifacts/_lib_$arch.so  secretflow/security/privacy/
                  mv secretflow/security/privacy/_lib_$arch.so secretflow/security/privacy/_lib.so
                  pip install -r dev-requirements.txt
                  pytest --testmon --env prod  -n auto --junitxml=results.xml -v -x --capture=no --cov=secretflow/  --cov-report=xml:coverage.xml  tests/stats/
            - save_cache:
                key: testmondata-stats_{{ arch }}-{{ .Branch }}-{{ .Revision }}
                paths:
                  - .testmondata
                when: always
            - store_test_results:
                path: ./results.xml
  linux_infra_test:
    docker:
      - image: secretflow/ubuntu-base-ci:latest
    parameters:
      resource_class:
        type: string
    resource_class: << parameters.resource_class >>
    shell: /bin/bash --login -eo pipefail
    steps:
      - checkout
      - when:
          condition:
            or:
                - << pipeline.parameters.base >>
                - << pipeline.parameters.infra >>
                - << pipeline.parameters.test_infra >>
          steps:
            - restore_cache:
                name: Restore pytest testmondata
                key: testmondata-infra_{{ arch }}-{{ .Branch }}-
            - restore_cache:
                name: restore pip cache
                key: pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - attach_workspace:
                at: /root/project/
            - run:
                name: "Run tests"
                command: |
                  conda init
                  arch=$(uname -i)
                  cp artifacts/_lib_$arch.so  secretflow/security/privacy/
                  mv secretflow/security/privacy/_lib_$arch.so secretflow/security/privacy/_lib.so
                  pip install -r dev-requirements.txt
                  pytest --testmon --env prod  -n auto --junitxml=results.xml -v -x --capture=no --cov=secretflow/  --cov-report=xml:coverage.xml  tests/data/ tests/device/ tests/security/ tests/utils/ tests/kuscia/
            - save_cache:
                key: testmondata-infra_{{ arch }}-{{ .Branch }}-{{ .Revision }}
                paths:
                  - .testmondata
                when: always
            - store_test_results:
                path: ./results.xml
  linux_component_test:
    docker:
      - image: secretflow/ubuntu-base-ci:latest
    parameters:
      resource_class:
        type: string
    resource_class: << parameters.resource_class >>
    shell: /bin/bash --login -eo pipefail
    steps:
      - checkout
      - when:
          condition:
            or:
                - << pipeline.parameters.base >>
                - << pipeline.parameters.sf_ml >>
                - << pipeline.parameters.sf_stats >>
                - << pipeline.parameters.sf_preprocessing >>
                - << pipeline.parameters.test_component >>
          steps:
            - restore_cache:
                name: Restore pytest testmondata
                key: testmondata-component_{{ arch }}-{{ .Branch }}-
            - restore_cache:
                name: restore pip cache
                key: pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - attach_workspace:
                at: /root/project/
            - run:
                name: "Run tests"
                command: |
                  conda init
                  arch=$(uname -i)
                  cp artifacts/_lib_$arch.so  secretflow/security/privacy/
                  mv secretflow/security/privacy/_lib_$arch.so secretflow/security/privacy/_lib.so
                  pip install -r dev-requirements.txt
                  pytest --testmon --env prod  -n auto --junitxml=results.xml -v -x --capture=no --cov=secretflow/  --cov-report=xml:coverage.xml  tests/component/
            - save_cache:
                key: testmondata-component_{{ arch }}-{{ .Branch }}-{{ .Revision }}
                paths:
                  - .testmondata
                when: always
            - store_test_results:
                path: ./results.xml
  linux_ml_sim_test:
    docker:
      - image: secretflow/ubuntu-base-ci:latest
    parameters:
      resource_class:
        type: string
    resource_class: << parameters.resource_class >>
    shell: /bin/bash --login -eo pipefail
    steps:
      - checkout
      - when:
          condition:
            or:
                - << pipeline.parameters.base >>
                - << pipeline.parameters.infra >>
                - << pipeline.parameters.sf_maths >>
                - << pipeline.parameters.sf_ml >>
                - << pipeline.parameters.sf_utils >>
                - << pipeline.parameters.test_ml >>
          steps:
            - restore_cache:
                name: Restore pytest testmondata
                key: testmondata-ml_sim_{{ arch }}-{{ .Branch }}-
            - restore_cache:
                name: restore pip cache
                key: pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - attach_workspace:
                at: /root/project/
            - run:
                name: "Run tests"
                command: |
                  conda init
                  arch=$(uname -i)
                  cp artifacts/_lib_$arch.so  secretflow/security/privacy/
                  mv secretflow/security/privacy/_lib_$arch.so secretflow/security/privacy/_lib.so
                  pip install -r dev-requirements.txt
                  pytest --testmon --env sim -n auto --junitxml=results.xml -v -x --capture=no --cov=secretflow/  --cov-report=xml:coverage.xml tests/ml/
            - save_cache:
                key: testmondata-ml_sim_{{ arch }}-{{ .Branch }}-{{ .Revision }}
                paths:
                  - .testmondata
                when: always
            - store_test_results:
                path: ./results.xml
  linux_other_sim_test:
    docker:
      - image: secretflow/ubuntu-base-ci:latest
    parameters:
      resource_class:
        type: string
    resource_class: << parameters.resource_class >>
    shell: /bin/bash --login -eo pipefail
    steps:
      - checkout
      - when:
          condition:
            or:
                - << pipeline.parameters.base >>
                - << pipeline.parameters.sf_any >>
                - << pipeline.parameters.test_any >>
          steps:
            - restore_cache:
                name: Restore pytest testmondata
                key: testmondata-other_sim_{{ arch }}-{{ .Branch }}-
            - restore_cache:
                name: restore pip cache
                key: pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - attach_workspace:
                at: /root/project/
            - run:
                name: "Run tests"
                command: |
                  conda init
                  arch=$(uname -i)
                  cp artifacts/_lib_$arch.so  secretflow/security/privacy/
                  mv secretflow/security/privacy/_lib_$arch.so secretflow/security/privacy/_lib.so
                  pip install -r dev-requirements.txt
                  pytest --testmon --env sim -n auto --junitxml=results.xml -v -x --capture=no --cov=secretflow/  --cov-report=xml:coverage.xml --ignore=tests/ml/ tests/
            - save_cache:
                key: testmondata-other_sim_{{ arch }}-{{ .Branch }}-{{ .Revision }}
                paths:
                  - .testmondata
                when: always
            - store_test_results:
                path: ./results.xml

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build_and_test:
    jobs:
      - linux_build:
          matrix:
            parameters:
              resource_class: ["2xlarge"]
      # - macos_build
      - linux_ml_test:
          matrix:
            parameters:
              resource_class: ["2xlarge+"]
          requires:
            - linux_build
      - linux_ml_sim_test:
          matrix:
            parameters:
              resource_class: ["2xlarge+"]
          requires:
            - linux_build
      - linux_preprocessing_test:
          matrix:
            parameters:
              resource_class: ["2xlarge+"]
          requires:
            - linux_build
      - linux_stats_test:
          matrix:
            parameters:
              resource_class: ["2xlarge+"]
          requires:
            - linux_build
      - linux_infra_test:
          matrix:
            parameters:
              resource_class: ["2xlarge+"]
          requires:
            - linux_build
      - linux_component_test:
          matrix:
            parameters:
              resource_class: ["2xlarge+"]
          requires:
            - linux_build
      - linux_other_sim_test:
          matrix:
            parameters:
              resource_class: ["2xlarge+"]
          requires:
            - linux_build
