# GRIDPure Implementation
This project reproduces the CVPR 2024 paper ["Can Protective Perturbation Safeguard Personal Data from Being Exploited by Stable Diffusion?"](https://openaccess.thecvf.com/content/CVPR2024/papers/Zhao_Can_Protective_Perturbation_Safeguard_Personal_Data_from_Being_Exploited_by_CVPR_2024_paper.pdf).

## Project Structure
```
├── GRIDPure/
    ├── advdm_data/           # Data processed by AdvDM
    ├── antidb_data/          # Data processed by Anti-Dreambooth
    ├── checkpoint/           # LoRA fine-tuning parameters
    ├── checkpoint_dreambooth/ # Dreambooth fine-tuning parameters
    ├── class_images/         # Class data for dreambooth fine-tuning
    ├── data/                 # Original data
    ├── dataset_process/      # Dataset preparation and processing
    ├── guided_diffusion/    
    ├── metrics/              # Metric results
    ├── output/               # Images generated by LoRA fine-tuned models
    ├── output_dreambooth/    # Images generated by Dreambooth fine-tuned models
    ├── purified_diffpure/    # Images purified using DiffPure
    ├── purified_gridpure/    # Images purified using GRIDPure
    ├── runners/            

Configuration files:
    ├── .gitignore          
    ├── imagenet.yml       
    ├── requirements.txt    
    ├── README.md        

Python files:
    ├── diffpure.py         # DiffPure implementation
    ├── evaluate_gen.py     # Generated image evaluation
    ├── evaluate_pure.py    # Purified image evaluation
    ├── generate_dreambooth.py # Dreambooth fine-tuned model generation
    ├── generate.py         # LoRA fine-tuned model generation
    ├── gridpure.py        # GRIDPure implementation
    ├── poison_adv.py      # AdvDM implementation
    ├── poison_anti_db.py  # Anti-Dreambooth implementation
    ├── train_dreambooth.py # Dreambooth fine-tuning implementation
    ├── train_text_to_image_lora.py # LoRA fine-tuning implementation

Shell scripts:
    ├── diffpure.sh        # DiffPure execution
    ├── evaluate_gen.sh    # Generated image evaluation
    ├── evaluate_pure.sh   # Purified image evaluation
    ├── generate_dreambooth.sh # Dreambooth model image generation
    ├── generate.sh        # LoRA model image generation
    ├── gridpure.sh       # GRIDPure execution
    ├── poison_gen.sh     # AdvDM and Anti-Dreambooth execution
    ├── run_all.sh        # Execute complete workflow
    ├── train_dreambooth_poison_clean.sh # Dreambooth fine-tuning with unpurified data
    ├── train_dreambooth_pure.sh        # Dreambooth fine-tuning with purified data
    ├── train_text_to_image_lora_poison_clean.sh # LoRA fine-tuning with unpurified data
    └── train_text_to_image_lora_pure.sh       # LoRA fine-tuning with purified data
```

## Environment Setup
1. Clone this repository
```bash
git clone [repository_url]
```

2. Install dependencies
```bash
pip install -r requirements.txt
```
3. Pre-trained models for Purification
We follow [**DiffPure**](https://github.com/NVlabs/DiffPure) to apply an unconditional diffusion model trained on ImageNet to our purification experiments:
- [Guided Diffusion](https://github.com/openai/guided-diffusion) for
  ImageNet: (`256x256 diffusion unconditional`: [download link](https://openaipublic.blob.core.windows.net/diffusion/jul-2021/256x256_diffusion_uncond.pt))

## Data Preparation
1. Prepare datasets:
   - Celeba-HQ 
   - WikiArt

2. Place data in corresponding subfolders under the `data/` directory:
```bash
mkdir -p data/celebahq-caption
mkdir -p data/wikiart
```

## Experimental Pipeline
### 1. Data Protection Processing
Apply Anti-Dreambooth and AdvDM methods to process data:
```bash
bash poison_gen.sh
```

### 2. Data Purification
Use both DiffPure and GrIDPure for data purification:
```bash
# DiffPure purification
bash diffpure.sh

# GrIDPure purification
bash gridpure.sh
```

### 3. Model Fine-tuning
Fine-tune models using seven types of data (original, protected, and purified):
```bash
# LoRA fine-tuning (unpurified data)
bash train_text_to_image_lora_poison_clean.sh

# LoRA fine-tuning (purified data)
bash train_text_to_image_lora_pure.sh

# Dreambooth fine-tuning (unpurified data)
bash train_dreambooth_poison_clean.sh

# Dreambooth fine-tuning (purified data)
bash train_dreambooth_pure.sh
```

### 4. Image Generation
Generate images using fine-tuned models:
```bash
# LoRA model generation
bash generate.sh

# Dreambooth model generation
bash generate_dreambooth.sh
```

### 5. Evaluation
Evaluate generated images:
```bash
# Evaluate generated images
bash evaluate_gen.sh

# Evaluate purified images
bash evaluate_pure.sh
```

## Detailed Workflow in Scripts
- `poison_gen.sh`: Data protection
- `diffpure.sh`/`gridpure.sh`: Data purification
- `train_*.sh`: Model fine-tuning
- `generate.sh`/`generate_dreambooth.sh`: Image generation
- `evaluate_*.sh`: Result evaluation
- `run_all.sh`: Execute complete experimental workflow