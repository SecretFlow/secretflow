# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
parameters:
  cpp:
    type: boolean
    default: false
  requirements:
    type: boolean
    default: false
  workflow:
    type: boolean
    default: false
  sf_data:
    type: boolean
    default: false
  sf_device:
    type: boolean
    default: false
  sf_distributed:
    type: boolean
    default: false
  sf_kuscia:
    type: boolean
    default: false
  sf_maths:
    type: boolean
    default: false
  sf_security:
    type: boolean
    default: false
  sf_ml_boost:
    type: boolean
    default: false
  sf_utils:
    type: boolean
    default: false
  test_boost:
    type: boolean
    default: false

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  linux_build:
    docker:
      - image: secretflow/ubuntu-base-ci:latest
    parameters:
      resource_class:
        type: string
    resource_class: << parameters.resource_class >>
    shell: /bin/bash --login -eo pipefail
    steps:
      - checkout
      - when:
          condition: << pipeline.parameters.cpp >>
          steps:
            - run:
                name: "build shared library"
                command: |
                  arch=$(uname -i)
                  bazel build //secretflow_lib/binding/...
                  cp bazel-bin/secretflow_lib/binding/_lib.so build/lib/_lib_$arch.so
                  ls -la build/lib
            - persist_to_workspace:
                root: build
                paths:
                  - lib
  macos_build:
    macos:
      xcode: 15.1
    resource_class: macos.m1.large.gen1
    steps:
      - checkout
      - when:
          condition: 
            or:
              - << pipeline.parameters.cpp >>
              - << pipeline.parameters.workflow >>
          steps:
            - run:
                name: "build shared library"
                command: |
                  bazel build //secretflow_lib/binding/...
                  cp bazel-bin/secretflow_lib/binding/_lib.so build/lib/_lib_mac.so
                  ls -la build/lib
            - persist_to_workspace:
                root: build
                paths:
                  - lib
# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build_and_test:
    jobs:
      - linux_build:
          matrix:
            parameters:
              resource_class: ["2xlarge", "arm.2xlarge"]
      - macos_build

